/***********************************************************************
 *
 * PROJECT:     Test Applications
 * MODULE:      Form Submission UTF-8 Regression
 * FILE:        formtest.goc
 *
 * AUTHOR:      Generated by ChatGPT
 *
 * DESCRIPTION:
 *      Regression coverage for HTML form submission encoding flags.
 *
 ***********************************************************************/

/***************************************************************************
 *              Include files
 ***************************************************************************/

@include <stdapp.goh>
#include <ansi/string.h>
#include <htmlfstr.h>
#include <char.h>

/***************************************************************************
 *              Class & Message Definitions
 ***************************************************************************/

@class FormTestProcessClass, GenProcessClass
{
    @message void MSG_FORM_TEST_RUN();
}
@classdecl FormTestProcessClass, neverSaved;

/***************************************************************************
 *              UI Objects
 ***************************************************************************/

@start  AppResource;

@object GenApplicationClass FormTestApp =
{
    GI_visMoniker = list { @FormTestTextMoniker };
    GI_comp = @FormTestPrimary;
    gcnList(MANUFACTURER_ID_GEOWORKS, GAGCNLT_WINDOWS) = @FormTestPrimary;
}

@visMoniker FormTestTextMoniker = "Form UTF-8 Test";

@end    AppResource

@start  Interface;

@object GenPrimaryClass FormTestPrimary =
{
    GI_comp = @FormTestResults;
    HINT_SIZE_WINDOW_AS_DESIRED;
    HINT_CENTER_CHILDREN_HORIZONTALLY;
}

@object GenTextClass FormTestResults =
{
    GI_visMoniker = "Regression Results:";
    GTXI_attrs = @default;
    GTXI_destination = process;
    HINT_PLACE_MONIKER_ABOVE;
    HINT_EXPAND_WIDTH_TO_FIT_PARENT;
    HINT_EXPAND_HEIGHT_TO_FIT_PARENT;
    HINT_TEXT_WHITE_WASH_COLOR;
}

@end    Interface

/***************************************************************************
 *              Forward Declarations
 ***************************************************************************/

#define FORM_TEST_RESULT_BUFFER_SIZE       256

static Boolean FormTestRunUrlEncodingTest(void);
static Boolean FormTestRunRawBodyTest(void);
static void FormTestAppendResult(char *buffer, word bufferSize, const char *label, Boolean passed);

/***************************************************************************
 *              Helper Functions
 ***************************************************************************/

static void FormTestAppendResult(char *buffer, word bufferSize, const char *label, Boolean passed)
{
    word currentLength;
    word labelLength;
    word statusLength;
    word requiredLength;
    const char *statusText;
    word index;

    currentLength = (word)strlen(buffer);
    statusText = passed ? "PASS" : "FAIL";
    labelLength = (word)strlen(label);
    statusLength = (word)strlen(statusText);

    if (currentLength > 0)
    {
        if ((currentLength + 1) >= bufferSize)
        {
            return;
        }
        buffer[currentLength] = '\n';
        buffer[currentLength + 1] = '\0';
        currentLength++;
    }

    requiredLength = currentLength + labelLength + 2 + statusLength + 1;
    if (requiredLength > bufferSize)
    {
        return;
    }

    for (index = 0; index < labelLength; index++)
    {
        buffer[currentLength + index] = label[index];
    }
    currentLength += labelLength;
    buffer[currentLength++] = ':';
    buffer[currentLength++] = ' ';
    for (index = 0; index < statusLength; index++)
    {
        buffer[currentLength + index] = statusText[index];
    }
    currentLength += statusLength;
    buffer[currentLength] = '\0';
}

static Boolean FormTestRunUrlEncodingTest(void)
{
    MemHandle formStringH;
    T_formString *formStringP;
    char *dataP;
    Boolean result;
    static const char expected[] = "?latin=f%E9o&utf=f%C3%A9o";
    TCHAR latinPrefix[] = _TEXT("?latin=");
    TCHAR utfPrefix[] = _TEXT("&utf=");
    TCHAR value[4];

    value[0] = (TCHAR)'f';
    value[1] = (TCHAR)C_LE_ACUTE;
    value[2] = (TCHAR)'o';
    value[3] = 0;

    formStringH = FormStringCreate();
    if (formStringH == NullHandle)
    {
        return FALSE;
    }

    formStringP = (T_formString *)(void *)MemLock(formStringH);
    formStringP->flags &= ~FORM_STRING_FLAG_UTF8_ENCODING;
    MemUnlock(formStringH);

    FormStringAppend(formStringH, latinPrefix);
    FormStringConvertAndAppend(formStringH, value);

    formStringP = (T_formString *)(void *)MemLock(formStringH);
    formStringP->flags |= FORM_STRING_FLAG_UTF8_ENCODING;
    MemUnlock(formStringH);

    FormStringAppend(formStringH, utfPrefix);
    FormStringConvertAndAppend(formStringH, value);

    dataP = (char *)(void *)FormStringDerefData(formStringH);
    result = (Boolean)(strcmp(dataP, expected) == 0);

    MemFree(formStringH);

    return result;
}

static Boolean FormTestRunRawBodyTest(void)
{
    MemHandle formStringH;
    T_formString *formStringP;
    char *dataP;
    Boolean result;
    static const char expected[] = "latin=\xE9&utf=\xC3\xA9";
    TCHAR latinPrefix[] = _TEXT("latin=");
    TCHAR utfPrefix[] = _TEXT("&utf=");
    TCHAR accent[2];

    accent[0] = (TCHAR)C_LE_ACUTE;
    accent[1] = 0;

    formStringH = FormStringCreate();
    if (formStringH == NullHandle)
    {
        return FALSE;
    }

    formStringP = (T_formString *)(void *)MemLock(formStringH);
    formStringP->flags &= ~FORM_STRING_FLAG_UTF8_ENCODING;
    MemUnlock(formStringH);

    FormStringAppend(formStringH, latinPrefix);
    FormStringAppend(formStringH, accent);

    formStringP = (T_formString *)(void *)MemLock(formStringH);
    formStringP->flags |= FORM_STRING_FLAG_UTF8_ENCODING;
    MemUnlock(formStringH);

    FormStringAppend(formStringH, utfPrefix);
    FormStringAppend(formStringH, accent);

    dataP = (char *)(void *)FormStringDerefData(formStringH);
    result = (Boolean)(strcmp(dataP, expected) == 0);

    MemFree(formStringH);

    return result;
}

/***************************************************************************
 *              Code for FormTestProcessClass
 ***************************************************************************/

@method FormTestProcessClass, MSG_PROCESS_OPEN_APPLICATION
{
    @callsuper();
    @call self::MSG_FORM_TEST_RUN();
}

@method FormTestProcessClass, MSG_FORM_TEST_RUN
{
    char resultBuffer[FORM_TEST_RESULT_BUFFER_SIZE];
    Boolean urlEncodingPass;
    Boolean rawBodyPass;

    resultBuffer[0] = '\0';

    urlEncodingPass = FormTestRunUrlEncodingTest();
    FormTestAppendResult(resultBuffer, FORM_TEST_RESULT_BUFFER_SIZE, "URL encoding", urlEncodingPass);

    rawBodyPass = FormTestRunRawBodyTest();
    FormTestAppendResult(resultBuffer, FORM_TEST_RESULT_BUFFER_SIZE, "Raw body", rawBodyPass);

    @call FormTestResults::MSG_VIS_TEXT_REPLACE_ALL_PTR(resultBuffer, 0);
}
